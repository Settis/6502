    INCDIR "../std"
    INCLUDE "std.asm"
    INCLUDE "in_ram.asm"

UART_STATE_ADDR = $FF
UART_ADDR_LOW = $FD
UART_ADDR_HIGH = $FE
UART_ADDR_LENGTH = $FC


UART_STATE_READY = 0
UART_STATE_WAIT_FOR_PING_DATA = 1
UART_STATE_WAIT_FOR_WRITE_OFFSET_LOW_BYTE = 2
UART_STATE_WAIT_FOR_WRITE_OFFSET_HIGH_BYTE = 3
UART_STATE_WAIT_FOR_WRITE_LENGTH = 4
UART_STATE_WAIT_FOR_WRITE_DATA = 5

UART_PING_COMMAND = 1
UART_WRITE_COMMAND = 2

IRQ_HANDLER:
    subroutine
    LDA UART_STATUS_REG
    ; skip checking
    LDA UART_STATE_ADDR
    CMP #UART_STATE_READY
    BNE .check_wait_ping_state
    JMP READ_UART_COMMAND
.check_wait_ping_state
    CMP #UART_STATE_WAIT_FOR_PING_DATA
    BNE .ignore
    JMP READ_PING_DATA
.ignore
    LDA UART_DATA_REG
    RTI

READ_UART_COMMAND:
    subroutine
    LDA UART_DATA_REG
    CMP #UART_PING_COMMAND
    BNE .check_write_command
    LDA #UART_STATE_WAIT_FOR_PING_DATA
    JMP .write
.check_write_command
    CMP #UART_WRITE_COMMAND
    BNE .ignore
    LDA #UART_STATE_WAIT_FOR_WRITE_OFFSET_LOW_BYTE
.write
    STA UART_STATE_ADDR
.ignore
    RTI

READ_PING_DATA:
    LDA UART_DATA_REG
    CLC
    ADC #1
    STA UART_DATA_REG
    LDA #UART_STATE_READY
    STA UART_STATE_ADDR
    RTI

debug_start:
reset_start:
    ; Set control register
    LDA #UART_CONTROL_DEFAULT
    STA UART_CONTROL_REG

    ; Set command register
    LDA #UART_COMMAND_PARITY_MOD_ENABLED | UART_COMMAND_RECEIVER_EVEN_PARITY_CHECKED | UART_COMMAND_TRANSMIT_INTERRUPT_DISABLED | UART_COMMAND_DATA_TERMINAL_READY
    ;LDA #%11101001
    STA UART_COMMAND_REG

    ; Init UART state mashine
    LDA #UART_STATE_READY
    STA UART_STATE_ADDR

    CLI

loop:
    jmp loop